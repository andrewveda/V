<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>V for Vocabulary</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=EB+Garamond:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --gold: #c9a84c;
    --gold-light: #e8c97a;
    --gold-dim: rgba(201,168,76,0.12);
    --deep: #faf7f2;
    --surface: #ffffff;
    --text: #2a2a2a;
    --text-muted: #7a766f;
    --text-dim: #b0a99f;
    --border-dim: rgba(0,0,0,0.06);
    --green: #2d7a4f;
    --green-light: #3da367;
    --green-dim: rgba(45,122,79,0.1);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'EB Garamond', serif;
    background: var(--deep);
    color: var(--text);
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    padding: 16px;
  }

  .dictionary-container {
    width: 100%;
    max-width: 520px;
    margin: auto;
    padding: 28px 24px;
    background: linear-gradient(145deg, #ffffff, #f8f2e8);
    border-radius: 14px;
    border: 1px solid var(--border-dim);
    box-shadow: 0 12px 35px rgba(0,0,0,0.06);
  }

  .subheading {
    text-align: center;
    font-size: 0.88em;
    color: var(--text-muted);
    margin-bottom: 20px;
    font-style: italic;
  }

  h2 {
    text-align: center;
    color: var(--text);
    font-family: 'Playfair Display', serif;
    font-weight: 700;
    font-size: 1.4em;
    margin-bottom: 18px;
    cursor: pointer;
    user-select: none;
    transition: opacity 0.2s;
  }
  h2:hover { opacity: 0.7; }

  /* â”€â”€ CALENDAR â”€â”€ */
  .calendar-container {
    background: var(--surface);
    border-radius: 10px;
    padding: 16px;
    border: 1px solid var(--border-dim);
    margin-bottom: 20px;
    display: none;
  }
  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
  }
  #month-year {
    font-weight: bold;
    font-size: 1.05em;
    color: var(--text);
    font-family: 'Playfair Display', serif;
  }
  .calendar-nav {
    cursor: pointer;
    font-size: 1.4em;
    color: var(--gold);
    padding: 4px 8px;
    border-radius: 6px;
    user-select: none;
    transition: background 0.2s;
  }
  .calendar-nav:hover { background: var(--gold-dim); }
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    text-align: center;
    font-size: 0.88em;
  }
  .day-name { font-weight: bold; color: var(--text-dim); padding: 7px 0; }
  .day {
    cursor: pointer;
    padding: 7px 0;
    border-radius: 50%;
    position: relative;
    transition: all 0.2s;
  }
  .day:not(.empty):hover { background: var(--gold-dim); }
  .day.empty { cursor: default; }
  .day.has-word::after {
    content: '';
    position: absolute;
    bottom: 5px; left: 50%;
    transform: translateX(-50%);
    width: 5px; height: 5px;
    background: var(--gold);
    border-radius: 50%;
  }
  .day.selected {
    background: linear-gradient(135deg, var(--gold), var(--gold-light));
    color: white;
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(201,168,76,0.3);
  }
  .day.selected.has-word::after { background: white; }

  /* â”€â”€ WORD ENTRIES â”€â”€ */
  .entry {
    margin-bottom: 12px;
    padding: 14px 16px;
    border-radius: 10px;
    background: linear-gradient(145deg, #ffffff, #f8f2e8);
    border: 1px solid var(--border-dim);
    box-shadow: 0 4px 14px rgba(0,0,0,0.04);
    display: flex;
    gap: 12px;
    align-items: flex-start;
  }
  .entry-check {
    flex-shrink: 0;
    margin-top: 4px;
    width: 20px; height: 20px;
    border-radius: 50%;
    border: 2px solid var(--gold);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.25s;
    font-size: 0.75em;
    color: transparent;
  }
  .entry-check.checked {
    background: linear-gradient(135deg, var(--green), var(--green-light));
    border-color: var(--green);
    color: white;
    box-shadow: 0 2px 8px rgba(45,122,79,0.3);
  }
  .entry-body { flex: 1; }
  .word {
    font-weight: bold;
    font-size: 1.2em;
    color: var(--gold);
    font-family: 'Playfair Display', serif;
  }
  .pronunciation {
    font-style: italic;
    color: var(--text-muted);
    font-size: 0.9em;
  }
  .meaning { margin-top: 5px; line-height: 1.55; font-size: 0.97em; }

  /* â”€â”€ SHARE BUTTONS â”€â”€ */
  .share-section {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .share-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    width: 100%;
    padding: 13px 16px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-family: 'EB Garamond', serif;
    font-size: 1em;
    font-weight: 600;
    letter-spacing: 0.02em;
    transition: all 0.25s;
  }
  .share-btn svg { flex-shrink: 0; }

  .btn-words {
    background: linear-gradient(135deg, #25d366, #1da851);
    color: white;
    box-shadow: 0 4px 14px rgba(37,211,102,0.3);
  }
  .btn-words:hover {
    box-shadow: 0 6px 20px rgba(37,211,102,0.4);
    transform: translateY(-1px);
  }

  .btn-completion {
    background: linear-gradient(135deg, var(--green), var(--green-light));
    color: white;
    box-shadow: 0 4px 14px rgba(45,122,79,0.25);
    opacity: 0.5;
    cursor: not-allowed;
    transition: all 0.3s;
  }
  .btn-completion.active {
    opacity: 1;
    cursor: pointer;
    box-shadow: 0 6px 18px rgba(45,122,79,0.35);
  }
  .btn-completion.active:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 22px rgba(45,122,79,0.4);
  }

  .completion-hint {
    text-align: center;
    font-size: 0.82em;
    color: var(--text-muted);
    font-style: italic;
  }

  /* â”€â”€ PROGRESS BAR â”€â”€ */
  .progress-bar-wrap {
    height: 4px;
    background: var(--border-dim);
    border-radius: 4px;
    margin-bottom: 16px;
    overflow: hidden;
  }
  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--green), var(--green-light));
    border-radius: 4px;
    transition: width 0.4s ease;
    width: 0%;
  }

  /* â”€â”€ FLOATING NAV â”€â”€ */
  .nav-fixed {
    position: fixed;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(201,168,76,0.12);
    backdrop-filter: blur(6px);
    color: var(--gold);
    padding: 10px 12px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.2em;
    z-index: 9999;
    user-select: none;
    border: 1px solid rgba(201,168,76,0.35);
    transition: all 0.25s;
    animation: soft-float 6s ease-in-out infinite;
    opacity: 0.85;
  }
  .nav-fixed:hover {
    background: linear-gradient(135deg, var(--gold), var(--gold-light));
    color: white;
    transform: translateY(-50%) scale(1.08);
    box-shadow: 0 6px 18px rgba(201,168,76,0.35);
  }
  #nav-prev-fixed { left: 14px; }
  #nav-next-fixed { right: 14px; }
  @keyframes soft-float {
    0%, 100% { transform: translateY(-50%) translateX(0); }
    50% { transform: translateY(-50%) translateX(1.5px); }
  }

  /* â”€â”€ HIDDEN CANVAS OVERLAY â”€â”€ */
  #share-canvas { display: none; }
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>

<div id="nav-prev-fixed" class="nav-fixed">&#10094;</div>
<div id="nav-next-fixed" class="nav-fixed">&#10095;</div>

<canvas id="share-canvas"></canvas>

<div class="dictionary-container">
  <div class="subheading">Curated by Ms. Roshan Fathima, Assistant Professor, Department of English</div>

  <h2 id="selected-date-display"></h2>

  <div class="calendar-container" id="calendar-container">
    <div class="calendar-header">
      <span class="calendar-nav" id="prev-month">&larr;</span>
      <span id="month-year"></span>
      <span class="calendar-nav" id="next-month">&rarr;</span>
    </div>
    <div class="calendar-grid">
      <div class="day-name">Sun</div><div class="day-name">Mon</div>
      <div class="day-name">Tue</div><div class="day-name">Wed</div>
      <div class="day-name">Thu</div><div class="day-name">Fri</div>
      <div class="day-name">Sat</div>
    </div>
    <div class="calendar-grid" id="calendar-days"></div>
  </div>

  <div class="progress-bar-wrap" id="progress-wrap" style="display:none">
    <div class="progress-bar-fill" id="progress-fill"></div>
  </div>

  <div id="word-list"></div>

  <div class="share-section" id="share-section" style="display:none">
    <button class="share-btn btn-words" id="btn-share-words" onclick="shareWords()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
      Share Today's Words on WhatsApp
    </button>

    <button class="share-btn btn-completion" id="btn-share-completion" onclick="shareCompletion()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
      Share My Completion Badge
    </button>
    <div class="completion-hint" id="completion-hint">Tick all words above to unlock the completion share âœ“</div>
  </div>
</div>

<script>
const sheetCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQsGIvL6Tfe9VMLQxiNtLVflhrTA1GcTKYtouNCqDTHpiA6G7Id3QilvntH5xIICpTrRuQyNGW_ouZi/pub?output=csv";

let allWords = [];
let datesWithWords = new Set();
let selectedDate = new Date();
selectedDate.setHours(0,0,0,0);
let calendarDate = new Date();
let checkedWords = new Set(); // tracks checked word indices for current date

const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const calendarDaysDiv = document.getElementById("calendar-days");
const monthYearSpan = document.getElementById("month-year");
const selectedDateDisplay = document.getElementById("selected-date-display");
const wordListDiv = document.getElementById("word-list");
const calendarContainer = document.getElementById("calendar-container");
const shareSection = document.getElementById("share-section");
const progressWrap = document.getElementById("progress-wrap");
const progressFill = document.getElementById("progress-fill");
const completionBtn = document.getElementById("btn-share-completion");
const completionHint = document.getElementById("completion-hint");

function formatDateObj(d) {
  const y = d.getFullYear();
  const m = (d.getMonth()+1).toString().padStart(2,'0');
  const day = d.getDate().toString().padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function formatSheetDate(dateStr) {
  if (!dateStr) return null;
  try {
    const d = new Date(dateStr.trim() + "T00:00:00");
    return formatDateObj(d);
  } catch(e) { return null; }
}

calendarDate.setDate(1);
renderCalendar();
displayWords();

fetch(sheetCSV)
  .then(r => r.text())
  .then(csvText => {
    const parsed = Papa.parse(csvText, { header: true });
    allWords = parsed.data.map(row => ({
      date: row["Date"] ? row["Date"].trim() : "",
      word: row["Word"] ? row["Word"].trim() : "",
      pronunciation: row["Pronunciation"] ? row["Pronunciation"].trim() : "",
      meaning: row["Meaning"] ? row["Meaning"].trim() : ""
    }));
    allWords.forEach(w => {
      const ds = formatSheetDate(w.date);
      if (ds) datesWithWords.add(ds);
    });
    renderCalendar();
    displayWords();
  });

function renderCalendar() {
  const month = calendarDate.getMonth();
  const year = calendarDate.getFullYear();
  monthYearSpan.innerText = `${monthNames[month]} ${year}`;
  calendarDaysDiv.innerHTML = "";
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();
  for (let i = 0; i < firstDay; i++) {
    const e = document.createElement("div"); e.className = "day empty"; calendarDaysDiv.appendChild(e);
  }
  for (let i = 1; i <= daysInMonth; i++) {
    const cell = document.createElement("div");
    cell.className = "day";
    cell.innerText = i;
    const d = new Date(year, month, i);
    const ds = formatDateObj(d);
    if (datesWithWords.has(ds)) cell.classList.add("has-word");
    if (ds === formatDateObj(selectedDate)) cell.classList.add("selected");
    cell.addEventListener("click", () => {
      selectedDate = d;
      checkedWords.clear();
      displayWords();
      renderCalendar();
      calendarContainer.style.display = "none";
    });
    calendarDaysDiv.appendChild(cell);
  }
}

function displayWords() {
  const dateStr = formatDateObj(selectedDate);
  selectedDateDisplay.innerText = selectedDate.toDateString();
  wordListDiv.innerHTML = "";
  checkedWords.clear();

  const todayWords = allWords.filter(w => formatSheetDate(w.date) === dateStr);

  if (allWords.length === 0) {
    wordListDiv.innerHTML = "<p style='color:var(--text-muted);font-style:italic;text-align:center;padding:12px'>Loading wordsâ€¦</p>";
    shareSection.style.display = "none";
    progressWrap.style.display = "none";
    return;
  }
  if (todayWords.length === 0) {
    wordListDiv.innerHTML = "<p style='color:var(--text-muted);font-style:italic;text-align:center;padding:12px'>No words found for this date.</p>";
    shareSection.style.display = "none";
    progressWrap.style.display = "none";
    return;
  }

  progressWrap.style.display = "block";
  progressFill.style.width = "0%";
  shareSection.style.display = "flex";
  updateCompletionState(todayWords.length);

  todayWords.forEach((w, idx) => {
    if (!w.word) return;
    const entry = document.createElement("div");
    entry.className = "entry";
    entry.innerHTML = `
      <div class="entry-check" id="chk-${idx}" onclick="toggleCheck(${idx}, ${todayWords.length})">âœ“</div>
      <div class="entry-body">
        <div class="word">${w.word}</div>
        <div class="pronunciation">${w.pronunciation}</div>
        <div class="meaning">${w.meaning}</div>
      </div>`;
    wordListDiv.appendChild(entry);
  });
}

function toggleCheck(idx, total) {
  const chk = document.getElementById(`chk-${idx}`);
  if (checkedWords.has(idx)) {
    checkedWords.delete(idx);
    chk.classList.remove("checked");
  } else {
    checkedWords.add(idx);
    chk.classList.add("checked");
  }
  const pct = (checkedWords.size / total) * 100;
  progressFill.style.width = pct + "%";
  updateCompletionState(total);
}

function updateCompletionState(total) {
  const allDone = checkedWords.size === total && total > 0;
  completionBtn.classList.toggle("active", allDone);
  completionHint.style.display = allDone ? "none" : "block";
}

// â”€â”€ CANVAS IMAGE GENERATION â”€â”€

function drawRoundedRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.lineTo(x+w-r, y);
  ctx.quadraticCurveTo(x+w, y, x+w, y+r);
  ctx.lineTo(x+w, y+h-r);
  ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h);
  ctx.lineTo(x+r, y+h);
  ctx.quadraticCurveTo(x, y+h, x, y+h-r);
  ctx.lineTo(x, y+r);
  ctx.quadraticCurveTo(x, y, x+r, y);
  ctx.closePath();
}

function generateWordsImage(todayWords, dateStr) {
  const W = 900, PAD = 60;
  const lineH = 76;
  const headerH = 170;
  const footerH = 80;
  const H = headerH + todayWords.length * lineH + footerH;

  const canvas = document.getElementById("share-canvas");
  canvas.width = W; canvas.height = H;
  const ctx = canvas.getContext("2d");

  // Background
  const bg = ctx.createLinearGradient(0,0,W,H);
  bg.addColorStop(0, "#fffdf7");
  bg.addColorStop(1, "#f8f0dc");
  ctx.fillStyle = bg; ctx.fillRect(0,0,W,H);

  // Gold border
  ctx.strokeStyle = "#c9a84c"; ctx.lineWidth = 6;
  drawRoundedRect(ctx, 10, 10, W-20, H-20, 18);
  ctx.stroke();

  // Inner thin border
  ctx.strokeStyle = "rgba(201,168,76,0.3)"; ctx.lineWidth = 1.5;
  drawRoundedRect(ctx, 20, 20, W-40, H-40, 14);
  ctx.stroke();

  // Title
  ctx.fillStyle = "#c9a84c";
  ctx.font = "bold 58px 'Georgia', serif";
  ctx.textAlign = "center";
  ctx.fillText("V for Vocabulary", W/2, 76);

  // Date
  ctx.fillStyle = "#7a766f";
  ctx.font = "italic 30px 'Georgia', serif";
  ctx.fillText(dateStr, W/2, 118);

  // Divider
  ctx.strokeStyle = "rgba(201,168,76,0.5)"; ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.moveTo(PAD, 140); ctx.lineTo(W-PAD, 140); ctx.stroke();

  // Words
  todayWords.forEach((w, i) => {
    const y = headerH + i * lineH + lineH/2;
    // Number
    ctx.fillStyle = "rgba(201,168,76,0.5)";
    ctx.font = "bold 26px 'Georgia', serif";
    ctx.textAlign = "right";
    ctx.fillText(`${i+1}.`, PAD + 28, y + 10);
    // Word
    ctx.fillStyle = "#2a2a2a";
    ctx.font = "bold 38px 'Georgia', serif";
    ctx.textAlign = "left";
    ctx.fillText(w.word, PAD + 40, y + 12);
  });

  // Footer
  ctx.fillStyle = "rgba(122,118,111,0.6)";
  ctx.font = "italic 22px 'Georgia', serif";
  ctx.textAlign = "center";
  ctx.fillText("Ms. Roshan Fathima Â· Department of English", W/2, H - 32);

  return canvas.toDataURL("image/png");
}

function generateCompletionImage(todayWords, dateStr) {
  const W = 900, H = 900;
  const canvas = document.getElementById("share-canvas");
  canvas.width = W; canvas.height = H;
  const ctx = canvas.getContext("2d");

  // Rich background
  const bg = ctx.createRadialGradient(W/2, H/2, 80, W/2, H/2, 500);
  bg.addColorStop(0, "#fffdf5");
  bg.addColorStop(1, "#f0e8d0");
  ctx.fillStyle = bg; ctx.fillRect(0,0,W,H);

  // Gold border
  ctx.strokeStyle = "#c9a84c"; ctx.lineWidth = 8;
  drawRoundedRect(ctx, 14, 14, W-28, H-28, 22);
  ctx.stroke();
  ctx.strokeStyle = "rgba(201,168,76,0.25)"; ctx.lineWidth = 2;
  drawRoundedRect(ctx, 28, 28, W-56, H-56, 16);
  ctx.stroke();

  // Big checkmark circle
  const cx = W/2, cy = 260, cr = 120;
  const circleGrad = ctx.createRadialGradient(cx-20, cy-20, 10, cx, cy, cr);
  circleGrad.addColorStop(0, "#3da367"); circleGrad.addColorStop(1, "#2d7a4f");
  ctx.fillStyle = circleGrad;
  ctx.beginPath(); ctx.arc(cx, cy, cr, 0, Math.PI*2); ctx.fill();

  // Checkmark
  ctx.strokeStyle = "white"; ctx.lineWidth = 18; ctx.lineCap = "round"; ctx.lineJoin = "round";
  ctx.beginPath();
  ctx.moveTo(cx - 55, cy);
  ctx.lineTo(cx - 12, cy + 50);
  ctx.lineTo(cx + 60, cy - 52);
  ctx.stroke();

  // Title
  ctx.fillStyle = "#2a2a2a";
  ctx.font = "bold 62px 'Georgia', serif";
  ctx.textAlign = "center";
  ctx.fillText("Words Conquered!", W/2, 440);

  // Date
  ctx.fillStyle = "#c9a84c";
  ctx.font = "italic 32px 'Georgia', serif";
  ctx.fillText(dateStr, W/2, 490);

  // Divider
  ctx.strokeStyle = "rgba(201,168,76,0.4)"; ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.moveTo(120, 520); ctx.lineTo(W-120, 520); ctx.stroke();

  // Words list (compact)
  const startY = 545;
  const cols = 2, colW = W/2 - 80;
  const rows = Math.ceil(todayWords.length / cols);
  todayWords.forEach((w, i) => {
    const col = i < rows ? 0 : 1;
    const row = i < rows ? i : i - rows;
    const x = col === 0 ? 100 : W/2 + 40;
    const y = startY + row * 42;
    ctx.fillStyle = "#2d7a4f";
    ctx.font = "bold 14px 'Georgia', serif";
    ctx.textAlign = "left";
    ctx.fillText("âœ“", x, y);
    ctx.fillStyle = "#2a2a2a";
    ctx.font = "bold 26px 'Georgia', serif";
    ctx.fillText(w.word, x + 24, y);
  });

  // Footer
  ctx.fillStyle = "rgba(122,118,111,0.65)";
  ctx.font = "italic 22px 'Georgia', serif";
  ctx.textAlign = "center";
  ctx.fillText("Ms. Roshan Fathima Â· Department of English", W/2, H - 40);

  return canvas.toDataURL("image/png");
}

function shareImageToWhatsApp(dataUrl, text) {
  // Try native share (mobile), fallback to download + WhatsApp link
  const blob = dataURItoBlob(dataUrl);
  const file = new File([blob], "vocabulary.png", { type: "image/png" });

  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    navigator.share({ files: [file], text: text }).catch(() => fallbackShare(dataUrl, text));
  } else {
    fallbackShare(dataUrl, text);
  }
}

function fallbackShare(dataUrl, text) {
  // Download image then open WhatsApp
  const link = document.createElement("a");
  link.href = dataUrl;
  link.download = "vocabulary.png";
  link.click();

  setTimeout(() => {
    const waUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
    window.open(waUrl, "_blank");
  }, 800);
}

function dataURItoBlob(dataURI) {
  const byteStr = atob(dataURI.split(',')[1]);
  const mimeStr = dataURI.split(',')[0].split(':')[1].split(';')[0];
  const ab = new ArrayBuffer(byteStr.length);
  const ia = new Uint8Array(ab);
  for (let i = 0; i < byteStr.length; i++) ia[i] = byteStr.charCodeAt(i);
  return new Blob([ab], { type: mimeStr });
}

function shareWords() {
  const dateStr = formatDateObj(selectedDate);
  const todayWords = allWords.filter(w => formatSheetDate(w.date) === dateStr && w.word);
  if (!todayWords.length) return;
  const img = generateWordsImage(todayWords, selectedDate.toDateString());
  const text = `ðŸ“š *V for Vocabulary* â€” ${selectedDate.toDateString()}\n\nToday's words:\n${todayWords.map((w,i)=>`${i+1}. *${w.word}*`).join('\n')}\n\n_Curated by Ms. Roshan Fathima, Dept. of English_`;
  shareImageToWhatsApp(img, text);
}

function shareCompletion() {
  if (!completionBtn.classList.contains("active")) return;
  const dateStr = formatDateObj(selectedDate);
  const todayWords = allWords.filter(w => formatSheetDate(w.date) === dateStr && w.word);
  const img = generateCompletionImage(todayWords, selectedDate.toDateString());
  const text = `âœ… I've read & learned all ${todayWords.length} vocabulary words for ${selectedDate.toDateString()}!\n\nðŸ“š *V for Vocabulary* by Ms. Roshan Fathima, Dept. of English andrewveda.github.io/SRM-VEC-English/PWA`;
  shareImageToWhatsApp(img, text);
}

// Calendar nav
document.getElementById("prev-month").addEventListener("click", () => {
  calendarDate.setMonth(calendarDate.getMonth()-1); renderCalendar();
});
document.getElementById("next-month").addEventListener("click", () => {
  calendarDate.setMonth(calendarDate.getMonth()+1); renderCalendar();
});
document.getElementById("selected-date-display").addEventListener("click", () => {
  const hidden = calendarContainer.style.display === "none" || !calendarContainer.style.display;
  calendarContainer.style.display = hidden ? "block" : "none";
  if (hidden) {
    calendarDate = new Date(selectedDate); calendarDate.setDate(1); renderCalendar();
  }
});

function getSortedDates() { return Array.from(datesWithWords).sort(); }
function goToAdjacentDate(dir) {
  const sorted = getSortedDates();
  const curr = formatDateObj(selectedDate);
  const idx = sorted.indexOf(curr);
  const newIdx = dir === "next" ? idx+1 : idx-1;
  if (newIdx < 0 || newIdx >= sorted.length) return;
  const [y,m,d] = sorted[newIdx].split("-").map(Number);
  selectedDate = new Date(y, m-1, d);
  checkedWords.clear();
  displayWords();
  calendarDate = new Date(selectedDate); calendarDate.setDate(1); renderCalendar();
  calendarContainer.style.display = "none";
}
document.getElementById("nav-prev-fixed").addEventListener("click", () => goToAdjacentDate("prev"));
document.getElementById("nav-next-fixed").addEventListener("click", () => goToAdjacentDate("next"));
</script>
</body>
</html>
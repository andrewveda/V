<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>V for Vocabulary</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=EB+Garamond:ital,wght@0,400;0,600;1,400&family=Fredoka+One&display=swap" rel="stylesheet">
<style>
  :root {
    --gold: #c9a84c;
    --gold-light: #e8c97a;
    --gold-dim: rgba(201,168,76,0.12);
    --deep: #faf7f2;
    --surface: #ffffff;
    --text: #2a2a2a;
    --text-muted: #7a766f;
    --text-dim: #b0a99f;
    --border-dim: rgba(0,0,0,0.06);
    --green: #2d7a4f;
    --green-light: #3da367;
    --ui-accent: #6c63ff;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'EB Garamond', serif; background: var(--deep); color: var(--text); display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 16px; }

  /* NAME SCREEN */
  #name-screen { width: 100%; max-width: 520px; margin: auto; background: linear-gradient(160deg, #1a1a2e, #0a0a18); border-radius: 20px; padding: 30px 24px; border: 2px solid rgba(108,99,255,0.4); box-shadow: 0 0 40px rgba(108,99,255,0.2); color: white; text-align: center; display: flex; flex-direction: column; align-items: center; }
  #name-screen h1 { font-family: 'Playfair Display', serif; font-size: 2rem; color: var(--gold); margin-bottom: 6px; }
  #name-screen .sub { font-style: italic; color: rgba(255,255,255,0.5); font-size: 0.9rem; margin-bottom: 24px; }
  .hero-quote { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; padding: 20px; margin-bottom: 24px; width: 100%; }
  .hero-text { font-family: 'Playfair Display', serif; font-size: 1.1rem; line-height: 1.6; color: #ffe082; text-shadow: 0 0 20px rgba(255,224,130,0.4); font-style: italic; }
  .hero-author { margin-top: 10px; font-size: 0.82rem; color: rgba(255,255,255,0.45); font-style: italic; }
  #name-screen select, #name-screen input { display: block; width: 100%; max-width: 320px; margin: 8px auto; padding: 12px 16px; font-size: 1rem; font-family: 'EB Garamond', serif; border-radius: 10px; border: 2px solid rgba(108,99,255,0.4); background: rgba(255,255,255,0.08); color: white; outline: none; transition: border 0.2s; }
  #name-screen select option { background: #1a1a2e; }
  #name-screen input::placeholder { color: rgba(255,255,255,0.4); }
  #name-screen select:focus, #name-screen input:focus { border-color: var(--ui-accent); }
  #start-btn { margin-top: 18px; padding: 14px 40px; font-family: 'Playfair Display', serif; font-size: 1.2rem; letter-spacing: 1px; border: none; border-radius: 14px; background: linear-gradient(135deg, var(--gold), var(--gold-light)); color: #2a1a00; cursor: pointer; box-shadow: 0 6px 20px rgba(201,168,76,0.5); transition: transform 0.2s, box-shadow 0.2s; font-weight: 700; }
  #start-btn:hover { transform: scale(1.05); box-shadow: 0 8px 30px rgba(201,168,76,0.7); }

  /* MAIN APP */
  .dictionary-container { width: 100%; max-width: 520px; margin: auto; padding: 28px 24px; background: linear-gradient(145deg, #ffffff, #f8f2e8); border-radius: 14px; border: 1px solid var(--border-dim); box-shadow: 0 12px 35px rgba(0,0,0,0.06); display: none; }
  .subheading { text-align: center; font-size: 0.88em; color: var(--text-muted); margin-bottom: 4px; font-style: italic; }
  .student-tag { text-align: center; font-size: 0.82em; color: var(--gold); margin-bottom: 16px; font-style: italic; opacity: 0.85; }
  h2 { text-align: center; color: var(--text); font-family: 'Playfair Display', serif; font-weight: 700; font-size: 1.4em; margin-bottom: 18px; cursor: pointer; user-select: none; transition: opacity 0.2s; }
  h2:hover { opacity: 0.7; }

  /* STUDY TIMER */
  .study-timer { display: flex; align-items: center; justify-content: center; gap: 12px; background: linear-gradient(135deg, #1a1a2e, #0d0d1f); border-radius: 14px; padding: 14px 20px; margin-bottom: 20px; border: 1px solid rgba(201,168,76,0.3); position: relative; overflow: hidden; transition: border-color 0.4s, box-shadow 0.4s; }
  .study-timer::before { content: ''; position: absolute; inset: 0; background: radial-gradient(ellipse at 50% 0%, rgba(201,168,76,0.08), transparent 70%); pointer-events: none; }
  .timer-icon { font-size: 1.4em; animation: pulse-icon 2s ease-in-out infinite; }
  @keyframes pulse-icon { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
  .timer-body { display: flex; flex-direction: column; align-items: center; }
  .timer-label { font-size: 0.7em; color: rgba(255,255,255,0.45); letter-spacing: 0.12em; text-transform: uppercase; font-family: 'EB Garamond', serif; }
  .timer-display { font-family: 'Playfair Display', serif; font-size: 2em; font-weight: 700; color: var(--gold-light); letter-spacing: 0.06em; line-height: 1.1; text-shadow: 0 0 20px rgba(201,168,76,0.4); transition: color 0.4s; }
  .timer-display.milestone { color: #3da367; text-shadow: 0 0 20px rgba(61,163,103,0.5); }
  .timer-milestone-badge { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); background: linear-gradient(135deg, var(--green), var(--green-light)); color: white; font-size: 0.72em; padding: 4px 10px; border-radius: 20px; font-family: 'EB Garamond', serif; font-style: italic; opacity: 0; transition: opacity 0.5s; pointer-events: none; white-space: nowrap; box-shadow: 0 2px 10px rgba(45,122,79,0.4); }
  .timer-milestone-badge.show { opacity: 1; animation: badge-pop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
  @keyframes badge-pop { from { transform: translateY(-50%) scale(0.7); opacity: 0; } to { transform: translateY(-50%) scale(1); opacity: 1; } }
  .timer-sub-label { font-size: 0.65em; color: rgba(255,255,255,0.3); font-style: italic; margin-top: 1px; font-family: 'EB Garamond', serif; transition: color 0.4s; text-align: center; }
  .timer-sub-label.active { color: rgba(61,163,103,0.8); }

  /* CALENDAR */
  .calendar-container { background: var(--surface); border-radius: 10px; padding: 16px; border: 1px solid var(--border-dim); margin-bottom: 20px; display: none; }
  .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
  #month-year { font-weight: bold; font-size: 1.05em; color: var(--text); font-family: 'Playfair Display', serif; }
  .calendar-nav { cursor: pointer; font-size: 1.4em; color: var(--gold); padding: 4px 8px; border-radius: 6px; user-select: none; transition: background 0.2s; }
  .calendar-nav:hover { background: var(--gold-dim); }
  .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; font-size: 0.88em; }
  .day-name { font-weight: bold; color: var(--text-dim); padding: 7px 0; }
  .day { cursor: pointer; padding: 7px 0; border-radius: 50%; position: relative; transition: all 0.2s; }
  .day:not(.empty):hover { background: var(--gold-dim); }
  .day.empty { cursor: default; }
  .day.has-word::after { content: ''; position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; background: var(--gold); border-radius: 50%; }
  .day.selected { background: linear-gradient(135deg, var(--gold), var(--gold-light)); color: white; font-weight: bold; box-shadow: 0 4px 12px rgba(201,168,76,0.3); }
  .day.selected.has-word::after { background: white; }

  /* ENTRIES */
  .entry { margin-bottom: 12px; padding: 14px 16px; border-radius: 10px; background: linear-gradient(145deg, #ffffff, #f8f2e8); border: 1px solid var(--border-dim); box-shadow: 0 4px 14px rgba(0,0,0,0.04); display: flex; gap: 12px; align-items: flex-start; }
  .entry-check { flex-shrink: 0; margin-top: 4px; width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--gold); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.25s; font-size: 0.75em; color: transparent; }
  .entry-check.checked { background: linear-gradient(135deg, var(--green), var(--green-light)); border-color: var(--green); color: white; box-shadow: 0 2px 8px rgba(45,122,79,0.3); }
  .entry-body { flex: 1; }
  .word { font-weight: bold; font-size: 1.2em; color: var(--gold); font-family: 'Playfair Display', serif; }
  .pronunciation { font-style: italic; color: var(--text-muted); font-size: 0.9em; }
  .meaning { margin-top: 5px; line-height: 1.55; font-size: 0.97em; }

  /* SHARE */
  .share-section { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
  .share-btn { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 13px 16px; border: none; border-radius: 10px; cursor: pointer; font-family: 'EB Garamond', serif; font-size: 1em; font-weight: 600; letter-spacing: 0.02em; transition: all 0.25s; }
  .share-btn svg { flex-shrink: 0; }
  .btn-words { background: linear-gradient(135deg, #25d366, #1da851); color: white; box-shadow: 0 4px 14px rgba(37,211,102,0.3); }
  .btn-words:hover { box-shadow: 0 6px 20px rgba(37,211,102,0.4); transform: translateY(-1px); }
  .btn-completion { background: linear-gradient(135deg, var(--green), var(--green-light)); color: white; box-shadow: 0 4px 14px rgba(45,122,79,0.25); opacity: 0.5; cursor: not-allowed; transition: all 0.3s; }
  .btn-completion.active { opacity: 1; cursor: pointer; box-shadow: 0 6px 18px rgba(45,122,79,0.35); }
  .btn-completion.active:hover { transform: translateY(-1px); box-shadow: 0 8px 22px rgba(45,122,79,0.4); }
  .completion-hint { text-align: center; font-size: 0.82em; color: var(--text-muted); font-style: italic; }

  /* PROGRESS BAR */
  .progress-bar-wrap { height: 4px; background: var(--border-dim); border-radius: 4px; margin-bottom: 16px; overflow: hidden; }
  .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--green), var(--green-light)); border-radius: 4px; transition: width 0.4s ease; width: 0%; }

  /* FLOATING NAV */
  .nav-fixed { position: fixed; top: 50%; transform: translateY(-50%); background: rgba(201,168,76,0.12); backdrop-filter: blur(6px); color: var(--gold); padding: 10px 12px; border-radius: 50%; cursor: pointer; font-size: 1.2em; z-index: 9999; user-select: none; border: 1px solid rgba(201,168,76,0.35); transition: all 0.25s; animation: soft-float 6s ease-in-out infinite; opacity: 0.85; }
  .nav-fixed:hover { background: linear-gradient(135deg, var(--gold), var(--gold-light)); color: white; transform: translateY(-50%) scale(1.08); box-shadow: 0 6px 18px rgba(201,168,76,0.35); }
  #nav-prev-fixed { left: 14px; }
  #nav-next-fixed { right: 14px; }
  @keyframes soft-float { 0%, 100% { transform: translateY(-50%) translateX(0); } 50% { transform: translateY(-50%) translateX(1.5px); } }
  #share-canvas { display: none; }
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>

<div id="nav-prev-fixed" class="nav-fixed" style="display:none">&#10094;</div>
<div id="nav-next-fixed" class="nav-fixed" style="display:none">&#10095;</div>
<canvas id="share-canvas"></canvas>

<div id="name-screen">
  <h1>V for Vocabulary</h1>
  <p class="sub">Curated by Ms. Roshan Fathima</p>
  <div class="hero-quote">
    <div class="hero-text">"The limits of my language<br>mean the limits of my world."</div>
    <div class="hero-author">‚Äî Ludwig Wittgenstein</div>
  </div>
  <select id="dept-select">
    <option value="">-- Select Department --</option>
    <option>Cyber Security</option><option>CSE-1</option><option>CSE-2</option>
    <option>CSE-3</option><option>Mechanical Engineering</option><option>ECE-1</option>
    <option>ECE-2</option><option>ECE-3</option><option>AI DS-1</option>
    <option>AI DS-2</option><option>Civil</option><option>Agri</option>
    <option>EEE</option><option>EIE</option><option>Medical Electronics</option>
    <option>IT-1</option><option>IT-2</option>
  </select>
  <input type="text" id="name-input" placeholder="Enter your name" />
  <button id="start-btn">üìñ Open Vocabulary</button>
</div>

<div class="dictionary-container" id="main-app">
  <div class="subheading">Curated by Ms. Roshan Fathima, Assistant Professor, Department of English</div>
  <div class="student-tag" id="student-tag"></div>
  <h2 id="selected-date-display"></h2>

  <div class="study-timer" id="study-timer" style="display:none">
    <div class="timer-icon" id="timer-icon">‚è±Ô∏è</div>
    <div class="timer-body">
      <div class="timer-label">Study Time</div>
      <div class="timer-display" id="timer-display">0:00</div>
      <div class="timer-sub-label" id="timer-sub-label">Keep reading ‚Äî let the words sink in</div>
    </div>
    <div class="timer-milestone-badge" id="milestone-badge"></div>
  </div>

  <div class="calendar-container" id="calendar-container">
    <div class="calendar-header">
      <span class="calendar-nav" id="prev-month">&larr;</span>
      <span id="month-year"></span>
      <span class="calendar-nav" id="next-month">&rarr;</span>
    </div>
    <div class="calendar-grid">
      <div class="day-name">Sun</div><div class="day-name">Mon</div>
      <div class="day-name">Tue</div><div class="day-name">Wed</div>
      <div class="day-name">Thu</div><div class="day-name">Fri</div>
      <div class="day-name">Sat</div>
    </div>
    <div class="calendar-grid" id="calendar-days"></div>
  </div>

  <div class="progress-bar-wrap" id="progress-wrap" style="display:none">
    <div class="progress-bar-fill" id="progress-fill"></div>
  </div>

  <div id="word-list"></div>

  <div class="share-section" id="share-section" style="display:none">
    <button class="share-btn btn-words" onclick="shareWords()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
      Share Today's Words on WhatsApp
    </button>
    <button class="share-btn btn-completion" id="btn-share-completion" onclick="shareCompletion()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
      Share My Completion Badge
    </button>
    <div class="completion-hint" id="completion-hint">Tick all words above to unlock the completion share ‚úì</div>
  </div>
</div>

<script>
const sheetCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQsGIvL6Tfe9VMLQxiNtLVflhrTA1GcTKYtouNCqDTHpiA6G7Id3QilvntH5xIICpTrRuQyNGW_ouZi/pub?output=csv";
const SUPABASE_URL = "https://ahezssoczvpbkteffcgz.supabase.co/functions/v1/logQuest";
const SHARE_LINK = "andrewveda.github.io/SRM-VEC-English-PWA";

let playerName = "", playerDept = "";
let allWords = [];
let datesWithWords = new Set();
let selectedDate = new Date(); selectedDate.setHours(0,0,0,0);
let calendarDate = new Date();
let checkedWords = new Set();
let completionLogged = false;
let timerInterval = null, timerSeconds = 0, lastMilestone = 0;

const MILESTONES = [
  { secs: 60,  icon: "üå±", label: "1 min ‚Äî warming up!" },
  { secs: 120, icon: "üìñ", label: "2 min ‚Äî nice focus!" },
  { secs: 180, icon: "‚ú®", label: "3 min ‚Äî words are sticking!" },
  { secs: 300, icon: "üî•", label: "5 min ‚Äî deep learner!" },
  { secs: 600, icon: "üèÜ", label: "10 min ‚Äî champion!" },
];
const SUBLABELS = [
  { secs: 0,   text: "Keep reading ‚Äî let the words sink in" },
  { secs: 60,  text: "Say each word aloud as you read it" },
  { secs: 120, text: "Try to use a word in a sentence" },
  { secs: 180, text: "Visualise each word's meaning" },
  { secs: 300, text: "Excellent depth of study!" },
  { secs: 600, text: "You're truly mastering these words üèÜ" },
];

function formatTimer(secs) {
  return `${Math.floor(secs/60)}:${(secs%60).toString().padStart(2,'0')}`;
}

function startTimer() {
  clearInterval(timerInterval); timerSeconds = 0; lastMilestone = 0;
  const display = document.getElementById('timer-display');
  const sublabel = document.getElementById('timer-sub-label');
  const badge = document.getElementById('milestone-badge');
  const icon = document.getElementById('timer-icon');
  const timerEl = document.getElementById('study-timer');
  timerEl.style.display = 'flex';
  display.textContent = '0:00'; display.className = 'timer-display';
  badge.className = 'timer-milestone-badge';
  sublabel.textContent = SUBLABELS[0].text; sublabel.className = 'timer-sub-label';
  timerInterval = setInterval(() => {
    timerSeconds++;
    display.textContent = formatTimer(timerSeconds);
    let lbl = SUBLABELS[0].text;
    for (const sl of SUBLABELS) { if (timerSeconds >= sl.secs) lbl = sl.text; }
    sublabel.textContent = lbl;
    for (const m of MILESTONES) {
      if (timerSeconds === m.secs && lastMilestone < m.secs) {
        lastMilestone = m.secs; icon.textContent = m.icon;
        badge.textContent = m.label; badge.className = 'timer-milestone-badge show';
        display.classList.add('milestone'); sublabel.classList.add('active');
        timerEl.style.borderColor = 'rgba(61,163,103,0.6)';
        timerEl.style.boxShadow = '0 0 20px rgba(61,163,103,0.2)';
        setTimeout(() => { timerEl.style.borderColor='rgba(201,168,76,0.3)'; timerEl.style.boxShadow=''; display.classList.remove('milestone'); sublabel.classList.remove('active'); }, 3000);
        setTimeout(() => { badge.className = 'timer-milestone-badge'; }, 4000);
        break;
      }
    }
  }, 1000);
}

const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const calendarDaysDiv = document.getElementById("calendar-days");
const monthYearSpan = document.getElementById("month-year");
const selectedDateDisplay = document.getElementById("selected-date-display");
const wordListDiv = document.getElementById("word-list");
const calendarContainer = document.getElementById("calendar-container");
const shareSection = document.getElementById("share-section");
const progressWrap = document.getElementById("progress-wrap");
const progressFill = document.getElementById("progress-fill");
const completionBtn = document.getElementById("btn-share-completion");
const completionHint = document.getElementById("completion-hint");

async function sendToSupabase(payload) {
  try { await fetch(SUPABASE_URL, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload) }); } catch(e) {}
}

function startApp(name, dept) {
  playerName = name; playerDept = dept;
  try { localStorage.setItem('pName', name); localStorage.setItem('pDept', dept); } catch(e) {}
  document.getElementById('name-screen').style.display = 'none';
  document.getElementById('main-app').style.display = 'block';
  document.getElementById('nav-prev-fixed').style.display = '';
  document.getElementById('nav-next-fixed').style.display = '';
  document.getElementById('student-tag').textContent = `üë§ ${name} ¬∑ ${dept}`;
  completionLogged = false;
  calendarDate = new Date(); calendarDate.setDate(1);
  renderCalendar(); displayWords();
  fetch(sheetCSV).then(r=>r.text()).then(csvText => {
    const parsed = Papa.parse(csvText, { header: true });
    allWords = parsed.data.map(row => ({
      date: row["Date"]?row["Date"].trim():"",
      word: row["Word"]?row["Word"].trim():"",
      pronunciation: row["Pronunciation"]?row["Pronunciation"].trim():"",
      meaning: row["Meaning"]?row["Meaning"].trim():""
    }));
    allWords.forEach(w => { const ds=formatSheetDate(w.date); if(ds) datesWithWords.add(ds); });
    renderCalendar(); displayWords();
  });
}

try {
  const sn = localStorage.getItem('pName'), sd = localStorage.getItem('pDept');
  if (sn && sd) { document.getElementById('name-input').value=sn; document.getElementById('dept-select').value=sd; startApp(sn,sd); }
  else { if(sn) document.getElementById('name-input').value=sn; if(sd) document.getElementById('dept-select').value=sd; }
} catch(e) {}

document.getElementById('start-btn').onclick = () => {
  const n=document.getElementById('name-input').value.trim(), d=document.getElementById('dept-select').value;
  if (!d) { alert('Please select your department!'); return; }
  if (!n) { alert('Please enter your name!'); return; }
  startApp(n, d);
};

function formatDateObj(d) {
  return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
}
function formatSheetDate(dateStr) {
  if (!dateStr) return null;
  try { return formatDateObj(new Date(dateStr.trim()+"T00:00:00")); } catch(e) { return null; }
}

function renderCalendar() {
  const month=calendarDate.getMonth(), year=calendarDate.getFullYear();
  monthYearSpan.innerText=`${monthNames[month]} ${year}`; calendarDaysDiv.innerHTML="";
  const firstDay=new Date(year,month,1).getDay(), daysInMonth=new Date(year,month+1,0).getDate();
  for (let i=0;i<firstDay;i++) { const e=document.createElement("div"); e.className="day empty"; calendarDaysDiv.appendChild(e); }
  for (let i=1;i<=daysInMonth;i++) {
    const cell=document.createElement("div"); cell.className="day"; cell.innerText=i;
    const d=new Date(year,month,i), ds=formatDateObj(d);
    if (datesWithWords.has(ds)) cell.classList.add("has-word");
    if (ds===formatDateObj(selectedDate)) cell.classList.add("selected");
    cell.addEventListener("click", () => { selectedDate=d; checkedWords.clear(); completionLogged=false; displayWords(); renderCalendar(); calendarContainer.style.display="none"; });
    calendarDaysDiv.appendChild(cell);
  }
}

function displayWords() {
  const dateStr=formatDateObj(selectedDate);
  selectedDateDisplay.innerText=selectedDate.toDateString();
  wordListDiv.innerHTML=""; checkedWords.clear();
  const todayWords=allWords.filter(w=>formatSheetDate(w.date)===dateStr);
  const timerEl=document.getElementById('study-timer');
  if (allWords.length===0) {
    wordListDiv.innerHTML="<p style='color:var(--text-muted);font-style:italic;text-align:center;padding:12px'>Loading words‚Ä¶</p>";
    shareSection.style.display="none"; progressWrap.style.display="none"; timerEl.style.display="none"; clearInterval(timerInterval); return;
  }
  if (todayWords.length===0) {
    wordListDiv.innerHTML="<p style='color:var(--text-muted);font-style:italic;text-align:center;padding:12px'>No words found for this date.</p>";
    shareSection.style.display="none"; progressWrap.style.display="none"; timerEl.style.display="none"; clearInterval(timerInterval); return;
  }
  progressWrap.style.display="block"; progressFill.style.width="0%";
  shareSection.style.display="flex"; updateCompletionState(todayWords.length);
  startTimer();
  todayWords.forEach((w,idx) => {
    if (!w.word) return;
    const entry=document.createElement("div"); entry.className="entry";
    entry.innerHTML=`<div class="entry-check" id="chk-${idx}" onclick="toggleCheck(${idx},${todayWords.length})">‚úì</div><div class="entry-body"><div class="word">${w.word}</div><div class="pronunciation">${w.pronunciation}</div><div class="meaning">${w.meaning}</div></div>`;
    wordListDiv.appendChild(entry);
  });
}

function toggleCheck(idx, total) {
  const chk=document.getElementById(`chk-${idx}`);
  if (checkedWords.has(idx)) { checkedWords.delete(idx); chk.classList.remove("checked"); }
  else { checkedWords.add(idx); chk.classList.add("checked"); }
  progressFill.style.width=(checkedWords.size/total*100)+"%";
  updateCompletionState(total);
}

function updateCompletionState(total) {
  const allDone=checkedWords.size===total&&total>0;
  completionBtn.classList.toggle("active", allDone);
  completionHint.style.display=allDone?"none":"block";
  if (allDone&&!completionLogged) {
    completionLogged=true;
    sendToSupabase({ student_name:playerName, department:playerDept, correct:total, wrong:0, time_spent:timerSeconds, quest_id:`VocabDate_${formatDateObj(selectedDate)}` });
  }
}

// ‚îÄ‚îÄ CANVAS HELPERS ‚îÄ‚îÄ
function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y); ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r); ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}

// ‚îÄ‚îÄ SHARED TEAL CARD BUILDER ‚îÄ‚îÄ
// Draws a card matching the uploaded WhatsApp promo style:
//   lime-green outer bg, deep teal card, word chips in a 2-column grid,
//   fun Fredoka One font, curiosity prompt + link at the bottom.
function buildTealCard(todayWords, headerFn) {
  const W = 900;
  const OUTER = 40, INNER = 36, GAP = 14, ROW_H = 90;
  const rows = Math.ceil(todayWords.length / 2);
  const HEADER_H = 150; // headerFn decides what goes here
  const FOOTER_H = 136;
  const H = OUTER*2 + HEADER_H + rows*(ROW_H+GAP) - GAP + INNER + FOOTER_H;

  const canvas = document.getElementById("share-canvas");
  canvas.width = W; canvas.height = H;
  const ctx = canvas.getContext("2d");

  // Lime-green outer background
  ctx.fillStyle = "#8dc63f";
  ctx.fillRect(0, 0, W, H);

  // Deep teal main card
  ctx.fillStyle = "#1a9d8d";
  roundRect(ctx, OUTER, OUTER, W-OUTER*2, H-OUTER*2, 30);
  ctx.fill();

  // Let caller draw header content
  headerFn(ctx, W, OUTER, HEADER_H);

  // Word chips ‚Äî 2-column grid
  const colW = (W - OUTER*2 - INNER*2 - GAP) / 2;
  const gridTop = OUTER + HEADER_H;
  for (let row=0; row<rows; row++) {
    for (let col=0; col<2; col++) {
      const wi = row*2+col;
      if (wi >= todayWords.length) continue;
      const x = OUTER+INNER + col*(colW+GAP);
      const y = gridTop + row*(ROW_H+GAP);
      // Chip
      ctx.fillStyle = "#22b5a4";
      roundRect(ctx, x, y, colW, ROW_H, 18);
      ctx.fill();
      // Word in fun font
      ctx.fillStyle = "#0d2b28";
      ctx.font = "bold 38px 'Fredoka One', 'Georgia', sans-serif";
      ctx.textAlign = "center";
      ctx.fillText(todayWords[wi].word, x+colW/2, y+ROW_H/2+14);
    }
  }

  // Footer
  const footerTop = gridTop + rows*(ROW_H+GAP) - GAP + INNER;
  ctx.textAlign = "center";
  ctx.fillStyle = "rgba(255,255,255,0.9)";
  ctx.font = "italic 26px 'Georgia', serif";
  ctx.fillText("Curious about what these words mean and", W/2, footerTop+30);
  ctx.fillText("how to pronounce them correctly? ü§î‚ú®", W/2, footerTop+62);
  ctx.fillStyle = "#ffffff";
  ctx.font = "bold 23px 'Georgia', serif";
  ctx.fillText("üîó  " + SHARE_LINK, W/2, footerTop+100);

  return canvas.toDataURL("image/png");
}

function generateWordsImage(todayWords, dateStr) {
  return buildTealCard(todayWords, (ctx, W, OUTER, HEADER_H) => {
    ctx.textAlign = "center";
    ctx.fillStyle = "#ffffff";
    ctx.font = "bold 64px 'Fredoka One', 'Georgia', sans-serif";
    ctx.fillText("Everyday Vocabulary", W/2, OUTER + 82);
    ctx.fillStyle = "rgba(255,255,255,0.65)";
    ctx.font = "italic 28px 'Georgia', serif";
    ctx.fillText(dateStr, W/2, OUTER + 120);
  });
}

function generateCompletionImage(todayWords, dateStr) {
  const studyTime = formatTimer(timerSeconds);
  // Taller header for the trophy + stats
  const W = 900;
  const OUTER = 40, INNER = 36, GAP = 14, ROW_H = 90;
  const rows = Math.ceil(todayWords.length / 2);
  const HEADER_H = 210;
  const FOOTER_H = 136;
  const H = OUTER*2 + HEADER_H + rows*(ROW_H+GAP) - GAP + INNER + FOOTER_H;

  const canvas = document.getElementById("share-canvas");
  canvas.width = W; canvas.height = H;
  const ctx = canvas.getContext("2d");

  ctx.fillStyle = "#8dc63f";
  ctx.fillRect(0, 0, W, H);

  ctx.fillStyle = "#1a9d8d";
  roundRect(ctx, OUTER, OUTER, W-OUTER*2, H-OUTER*2, 30);
  ctx.fill();

  // Header
  ctx.textAlign = "center";
  ctx.fillStyle = "#ffffff";
  ctx.font = "bold 62px 'Fredoka One', 'Georgia', sans-serif";
  ctx.fillText("Words Conquered! üèÜ", W/2, OUTER+80);
  ctx.fillStyle = "rgba(255,255,255,0.68)";
  ctx.font = "italic 28px 'Georgia', serif";
  ctx.fillText(dateStr, W/2, OUTER+116);
  ctx.fillStyle = "#b6f5a0";
  ctx.font = "bold 26px 'Georgia', serif";
  ctx.fillText("‚è±  Studied for " + studyTime, W/2, OUTER+154);

  // Word chips with check marks
  const colW = (W - OUTER*2 - INNER*2 - GAP) / 2;
  const gridTop = OUTER + HEADER_H;
  for (let row=0; row<rows; row++) {
    for (let col=0; col<2; col++) {
      const wi = row*2+col;
      if (wi >= todayWords.length) continue;
      const x = OUTER+INNER + col*(colW+GAP);
      const y = gridTop + row*(ROW_H+GAP);
      ctx.fillStyle = "#22b5a4";
      roundRect(ctx, x, y, colW, ROW_H, 18);
      ctx.fill();
      // Check mark
      ctx.fillStyle = "#5dde8a";
      ctx.font = "bold 24px 'Georgia', serif";
      ctx.textAlign = "left";
      ctx.fillText("‚úì", x+16, y+ROW_H/2+9);
      // Word
      ctx.fillStyle = "#0d2b28";
      ctx.font = "bold 36px 'Fredoka One', 'Georgia', sans-serif";
      ctx.textAlign = "center";
      ctx.fillText(todayWords[wi].word, x+colW/2+16, y+ROW_H/2+13);
    }
  }

  // Footer
  const footerTop = gridTop + rows*(ROW_H+GAP) - GAP + INNER;
  ctx.textAlign = "center";
  ctx.fillStyle = "rgba(255,255,255,0.9)";
  ctx.font = "italic 26px 'Georgia', serif";
  ctx.fillText("Curious about what these words mean and", W/2, footerTop+30);
  ctx.fillText("how to pronounce them correctly? ü§î‚ú®", W/2, footerTop+62);
  ctx.fillStyle = "#ffffff";
  ctx.font = "bold 23px 'Georgia', serif";
  ctx.fillText("üîó  " + SHARE_LINK, W/2, footerTop+100);

  return canvas.toDataURL("image/png");
}

function shareImageToWhatsApp(dataUrl, text) {
  const blob = dataURItoBlob(dataUrl);
  const file = new File([blob], "vocabulary.png", { type:"image/png" });
  if (navigator.canShare && navigator.canShare({ files:[file] })) {
    navigator.share({ files:[file], text }).catch(() => fallbackShare(dataUrl, text));
  } else { fallbackShare(dataUrl, text); }
}

function fallbackShare(dataUrl, text) {
  const link=document.createElement("a"); link.href=dataUrl; link.download="vocabulary.png"; link.click();
  setTimeout(() => { window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, "_blank"); }, 800);
}

function dataURItoBlob(dataURI) {
  const byteStr=atob(dataURI.split(',')[1]), mimeStr=dataURI.split(',')[0].split(':')[1].split(';')[0];
  const ab=new ArrayBuffer(byteStr.length), ia=new Uint8Array(ab);
  for (let i=0;i<byteStr.length;i++) ia[i]=byteStr.charCodeAt(i);
  return new Blob([ab], { type:mimeStr });
}

function shareWords() {
  const dateStr=formatDateObj(selectedDate);
  const todayWords=allWords.filter(w=>formatSheetDate(w.date)===dateStr&&w.word);
  if (!todayWords.length) return;
  const img=generateWordsImage(todayWords, selectedDate.toDateString());
  const text=`üìö *Everyday Vocabulary* ‚Äî ${selectedDate.toDateString()}\n\n${todayWords.map((w,i)=>`${i+1}. *${w.word}*`).join('\n')}\n\nCurious about meanings & pronunciation? ü§î‚ú®\nüîó https://${SHARE_LINK}\n\n_Curated by Ms. Roshan Fathima, Dept. of English_`;
  shareImageToWhatsApp(img, text);
}

function shareCompletion() {
  if (!completionBtn.classList.contains("active")) return;
  const dateStr=formatDateObj(selectedDate);
  const todayWords=allWords.filter(w=>formatSheetDate(w.date)===dateStr&&w.word);
  const img=generateCompletionImage(todayWords, selectedDate.toDateString());
  const text=`üèÜ I've conquered all ${todayWords.length} vocabulary words for ${selectedDate.toDateString()}!\n‚è± Studied for ${formatTimer(timerSeconds)}\n\nCurious about meanings & pronunciation? ü§î‚ú®\nüîó https://${SHARE_LINK}\n\n_V for Vocabulary by Ms. Roshan Fathima, Dept. of English_`;
  shareImageToWhatsApp(img, text);
}

document.getElementById("prev-month").addEventListener("click", () => { calendarDate.setMonth(calendarDate.getMonth()-1); renderCalendar(); });
document.getElementById("next-month").addEventListener("click", () => { calendarDate.setMonth(calendarDate.getMonth()+1); renderCalendar(); });
document.getElementById("selected-date-display").addEventListener("click", () => {
  const hidden=calendarContainer.style.display==="none"||!calendarContainer.style.display;
  calendarContainer.style.display=hidden?"block":"none";
  if (hidden) { calendarDate=new Date(selectedDate); calendarDate.setDate(1); renderCalendar(); }
});

function getSortedDates() { return Array.from(datesWithWords).sort(); }
function goToAdjacentDate(dir) {
  const sorted=getSortedDates(), curr=formatDateObj(selectedDate), idx=sorted.indexOf(curr);
  const newIdx=dir==="next"?idx+1:idx-1;
  if (newIdx<0||newIdx>=sorted.length) return;
  const [y,m,d]=sorted[newIdx].split("-").map(Number);
  selectedDate=new Date(y,m-1,d); checkedWords.clear(); completionLogged=false;
  displayWords(); calendarDate=new Date(selectedDate); calendarDate.setDate(1);
  renderCalendar(); calendarContainer.style.display="none";
}
document.getElementById("nav-prev-fixed").addEventListener("click", ()=>goToAdjacentDate("prev"));
document.getElementById("nav-next-fixed").addEventListener("click", ()=>goToAdjacentDate("next"));
</script>
</body>
</html>